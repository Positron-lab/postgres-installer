# Postgres Installer

Приложение для установки и настройки PostgreSQL на наименее загруженном из двух удалённых серверов.

## Требования

- Debian или совместимая ОС
- AlmaLinux или совместимая ОС
- Python 3.6+
- SSH доступ по ключу (от исполнителя к целевым серверам)
- Открыт порт 22 (SSH) и 5432 (PostgreSQL)
- Unzip для распаковки архива
- Установленный ansible
- На целевых серверах - актуальные репозитории, доступ в Интернет

## На целевых серверах

- Создать пользователя или использовать существующего (имя пользователя должно быть одинаковым на обоих целевых серверах)
- Настроить SSH доступ без пароля (скопировать ключ на целевые сервера)
- Если используется не root, то убрать запрос пароля при выполнении команд с sudo: В /etc/sudoers в конце прописать <user> ALL=(ALL)   NOPASSWD:ALL
- Открыть порт 5432, если используется firewall

## Использование

- Загрузить архив на сервер-исполнитель
- Распаковать архив unzip-ом
- Установить зависимости
```bash
pip install -r requirements.txt
```
- В скрипте install_postgres.py прописать пользователя на удаленном сервере (имя пользователя должно быть одинаковым на обоих целевых серверах) и путь до SSH ключа
- SSH_USER = "<user>"
- SSH_KEY = "/home/<user>/.ssh/id_rsa" (пример)
- Прописать ip целевых серверов в файле /ansible/inventory.ini
[target]
<x.x.x.x>
[other]
<y.y.y.y>
- Прописать ip-адреса целевых серверов и исполнителя в файле /ansible/install_postgres.yml в трёх секциях Allow student from:
host  all  student  <x.x.x.x>/32  md5
- Запуск
```bash
python3 install_postgres.py x.x.x.x,y.y.y.y
```
- При возникновении ошибки о том, что директории, к которым подключается скрипт на удаленных серверах, не используются:
1. Убедиться, что на машинах используются стандартные директории для разворачивания Postgres (посмотреть соответствие путей в /ansible/install_postgres.yml)
2. Снова запустить скрипт
```bash
python3 install_postgres.py x.x.x.x,y.y.y.y
```
## Описание

- Подключается к двум серверам по SSH (ключ уже подложен).
- Оценивает нагрузку.
- Выбирает наименее загруженный сервер.
- Устанавливает и настраивает PostgreSQL.
- Разрешает подключения к пользователю `student` только с IP второго сервера.
- Проверяет, отвечает ли PostgreSQL через `SELECT 1`.

## Принятые решения

- Использование `paramiko` для SSH.
- Установка через Ansible.
- Проверка БД с помощью `psycopg2`.
- Разные пути до файлов Postgres в Debian и AlmaLinux - жесткое задание пути

